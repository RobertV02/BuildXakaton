{% extends 'base.html' %}
{% block title %}{{ remark.category }} - {{ remark.object.name }}{% endblock %}
{% block subtitle %}{{ remark.object.name }}{% endblock %}

{% block content %}
<div class="max-w-6xl mx-auto space-y-8">
  <!-- Breadcrumb -->
  <nav class="flex items-center gap-2 text-sm text-gray-600 mb-8">
    <a href="{% url 'objects:detail' remark.object.id %}?tab=remarks" class="flex items-center gap-1 hover:text-blue-600 transition-colors font-medium">
      <svg class="w-4 h-4" fill="currentColor" viewBox="0 0 20 20">
        <path d="M10.707 2.293a1 1 0 00-1.414 0l-7 7a1 1 0 001.414 1.414L4 10.414V17a1 1 0 001 1h2a1 1 0 001-1v-2a1 1 0 011-1h2a1 1 0 011 1v2a1 1 0 001 1h2a1 1 0 001-1v-6.586l.293.293a1 1 0 001.414-1.414l-7-7z"></path>
      </svg>
      {{ remark.object.name }}
    </a>
    <svg class="w-4 h-4 text-gray-400" fill="currentColor" viewBox="0 0 20 20">
      <path fill-rule="evenodd" d="M7.293 14.707a1 1 0 010-1.414L10.586 10 7.293 6.707a1 1 0 111.414-1.414l4 4a1 1 0 010 1.414l-4 4a1 1 0 01-1.414 0z" clip-rule="evenodd"></path>
    </svg>
    <span class="text-gray-900 font-semibold">{{ remark.category }}</span>
  </nav>

  <!-- Remark Header -->
  <div class="glass-effect rounded-3xl border border-white/20 backdrop-blur-sm overflow-hidden">
    <div class="bg-gradient-to-r from-red-50/50 to-orange-50/50 px-8 py-6 border-b border-white/30">
      <div class="flex flex-col lg:flex-row lg:items-center lg:justify-between gap-6">
        <div class="flex flex-col sm:flex-row sm:items-center gap-4">
          <h1 class="text-2xl font-bold text-gray-900">{{ remark.category }}</h1>
          <div class="flex items-center gap-3">
            <span class="inline-flex items-center px-4 py-2 rounded-xl text-sm font-bold shadow-sm {% if remark.status == 'OPEN' %}bg-gradient-to-r from-red-500 to-rose-600 text-white{% elif remark.status == 'IN_PROGRESS' %}bg-gradient-to-r from-amber-500 to-orange-600 text-white{% elif remark.status == 'RESOLVED' %}bg-gradient-to-r from-emerald-500 to-green-600 text-white{% elif remark.status == 'ACCEPTED' %}bg-gradient-to-r from-blue-500 to-indigo-600 text-white{% else %}bg-gradient-to-r from-gray-500 to-gray-600 text-white{% endif %}">
              {{ remark.get_status_display }}
            </span>
            <span class="inline-flex items-center px-4 py-2 rounded-xl text-sm font-bold shadow-sm {% if remark.severity == 'LOW' %}bg-gradient-to-r from-gray-400 to-gray-500 text-white{% elif remark.severity == 'MEDIUM' %}bg-gradient-to-r from-amber-500 to-orange-600 text-white{% elif remark.severity == 'HIGH' %}bg-gradient-to-r from-red-500 to-rose-600 text-white{% else %}bg-gradient-to-r from-red-600 to-rose-700 text-white{% endif %}">
              {{ remark.get_severity_display }}
            </span>
          </div>
        </div>
        <div class="text-right">
          <p class="text-sm text-gray-600 font-medium">Создано {{ remark.created_at|date:'d.m.Y H:i' }}</p>
          {% if remark.created_by %}
            <p class="text-sm text-gray-800 font-semibold">{{ remark.created_by.get_full_name|default:remark.created_by.username }}</p>
          {% endif %}
        </div>
      </div>
    </div>

    <div class="p-8">
      <div class="grid grid-cols-1 xl:grid-cols-3 gap-8">
        <!-- Main Content -->
        <div class="xl:col-span-2 space-y-8">
          <!-- Description -->
          <div class="glass-effect rounded-2xl p-6 border border-white/20 backdrop-blur-sm">
            <h3 class="text-xl font-bold text-gray-900 mb-6 flex items-center gap-3">
              <div class="w-10 h-10 bg-gradient-to-br from-red-500 to-rose-600 rounded-xl flex items-center justify-center">
                <svg class="w-5 h-5 text-white" fill="currentColor" viewBox="0 0 20 20">
                  <path fill-rule="evenodd" d="M18 10a8 8 0 11-16 0 8 8 0 0116 0zm-7-4a1 1 0 11-2 0 1 1 0 012 0zM9 9a1 1 0 000 2v3a1 1 0 001 1h1a1 1 0 100-2v-3a1 1 0 00-1-1H9z" clip-rule="evenodd"></path>
                </svg>
              </div>
              Описание нарушения
            </h3>
            <div class="bg-gray-50/50 backdrop-blur-sm rounded-xl p-6 border border-white/30">
              <p class="text-gray-800 text-lg leading-relaxed whitespace-pre-wrap">{{ remark.description }}</p>
            </div>
          </div>

          <!-- Details -->
          <div class="glass-effect rounded-2xl p-6 border border-white/20 backdrop-blur-sm">
            <h3 class="text-xl font-bold text-gray-900 mb-6 flex items-center gap-3">
              <div class="w-10 h-10 bg-gradient-to-br from-blue-500 to-indigo-600 rounded-xl flex items-center justify-center">
                <svg class="w-5 h-5 text-white" fill="currentColor" viewBox="0 0 20 20">
                  <path fill-rule="evenodd" d="M4 4a2 2 0 00-2 2v8a2 2 0 002 2h12a2 2 0 002-2V6a2 2 0 00-2-2H4zm0 2h12v8H4V6z" clip-rule="evenodd"></path>
                </svg>
              </div>
              Детали нарушения
            </h3>
            <div class="bg-gray-50/50 backdrop-blur-sm rounded-xl p-6 border border-white/30 space-y-4">
              <div class="flex justify-between items-center py-3 border-b border-white/30">
                <span class="text-sm font-semibold text-gray-700">Наименование:</span>
                <span class="text-sm text-gray-900 font-medium">{{ remark.name|default:"Не указано" }}</span>
              </div>
              <div class="flex justify-between items-center py-3 border-b border-white/30">
                <span class="text-sm font-semibold text-gray-700">Вид:</span>
                <span class="text-sm text-gray-900 font-medium">{{ remark.get_fixability_display }}</span>
              </div>
              <div class="flex justify-between items-center py-3 border-b border-white/30">
                <span class="text-sm font-semibold text-gray-700">Тип:</span>
                <span class="text-sm text-gray-900 font-medium">{{ remark.get_issue_type_display }}</span>
              </div>
              <div class="flex justify-between items-center py-3">
                <span class="text-sm font-semibold text-gray-700">Срок устранения:</span>
                <span class="text-sm text-gray-900 font-medium">{{ remark.resolution_deadline_days|default:"Не указано" }}</span>
              </div>
            </div>
          </div>

          <!-- Photos -->
          {% if remark.photos.all %}
            <div class="glass-effect rounded-2xl p-6 border border-white/20 backdrop-blur-sm">
              <h3 class="text-xl font-bold text-gray-900 mb-6 flex items-center gap-3">
                <div class="w-10 h-10 bg-gradient-to-br from-purple-500 to-pink-600 rounded-xl flex items-center justify-center">
                  <svg class="w-5 h-5 text-white" fill="currentColor" viewBox="0 0 20 20">
                    <path fill-rule="evenodd" d="M4 3a2 2 0 00-2 2v10a2 2 0 002 2h12a2 2 0 002-2V5a2 2 0 00-2-2H4zm12 12H4l4-8 3 6 2-4 3 6z" clip-rule="evenodd"></path>
                  </svg>
                </div>
                Фотографии
              </h3>
              <div class="grid grid-cols-2 md:grid-cols-3 gap-4">
                {% for photo in remark.photos.all %}
                  <div class="aspect-square bg-gray-100 rounded-xl overflow-hidden group cursor-pointer transform transition-all duration-300 hover:scale-105 hover:shadow-xl">
                    <img src="{{ photo.file.url }}" alt="Фото нарушения" class="w-full h-full object-cover transition-transform duration-300 group-hover:scale-110">
                  </div>
                {% endfor %}
              </div>
            </div>
          {% endif %}

          <!-- Location -->
          {% if remark.latitude and remark.longitude %}
            <div class="glass-effect rounded-2xl p-6 border border-white/20 backdrop-blur-sm">
              <h3 class="text-xl font-bold text-gray-900 mb-6 flex items-center gap-3">
                <div class="w-10 h-10 bg-gradient-to-br from-green-500 to-emerald-600 rounded-xl flex items-center justify-center">
                  <svg class="w-5 h-5 text-white" fill="currentColor" viewBox="0 0 20 20">
                    <path fill-rule="evenodd" d="M5.05 4.05a7 7 0 119.9 9.9L10 18.9l-4.95-4.95a7 7 0 010-9.9zM10 11a2 2 0 100-4 2 2 0 000 4z" clip-rule="evenodd"></path>
                  </svg>
                </div>
                Местоположение
              </h3>
              <div class="bg-gray-50/50 backdrop-blur-sm rounded-xl p-6 border border-white/30">
                <p class="text-gray-800 font-medium">
                  Координаты: {{ remark.latitude|floatformat:6 }}, {{ remark.longitude|floatformat:6 }}
                </p>
              </div>
            </div>
          {% endif %}
        </div>

        <!-- Sidebar -->
        <div class="space-y-6">
          <!-- Object Info -->
          <div class="glass-effect rounded-2xl p-6 border border-white/20 backdrop-blur-sm">
            <h4 class="text-lg font-bold text-gray-900 mb-4 flex items-center gap-2">
              <div class="w-8 h-8 bg-gradient-to-br from-blue-500 to-indigo-600 rounded-lg flex items-center justify-center">
                <svg class="w-4 h-4 text-white" fill="currentColor" viewBox="0 0 20 20">
                  <path d="M10.707 2.293a1 1 0 00-1.414 0l-7 7a1 1 0 001.414 1.414L4 10.414V17a1 1 0 001 1h2a1 1 0 001-1v-2a1 1 0 011-1h2a1 1 0 011 1v2a1 1 0 001 1h2a1 1 0 001-1v-6.586l.293.293a1 1 0 001.414-1.414l-7-7z"></path>
                </svg>
              </div>
              Объект
            </h4>
            <a href="{% url 'objects:detail' remark.object.id %}" class="block text-blue-600 hover:text-blue-800 font-semibold text-lg transition-colors">
              {{ remark.object.name }}
            </a>
            <p class="text-sm text-gray-600 mt-2 leading-relaxed">{{ remark.object.description|truncatechars:100 }}</p>
          </div>

          <!-- Category Info -->
          <div class="glass-effect rounded-2xl p-6 border border-white/20 backdrop-blur-sm">
            <h4 class="text-lg font-bold text-gray-900 mb-4 flex items-center gap-2">
              <div class="w-8 h-8 bg-gradient-to-br from-purple-500 to-pink-600 rounded-lg flex items-center justify-center">
                <svg class="w-4 h-4 text-white" fill="currentColor" viewBox="0 0 20 20">
                  <path fill-rule="evenodd" d="M3 4a1 1 0 011-1h12a1 1 0 011 1v2a1 1 0 01-1 1H4a1 1 0 01-1-1V4zm0 4a1 1 0 011-1h12a1 1 0 011 1v2a1 1 0 01-1 1H4a1 1 0 01-1-1V8zm0 4a1 1 0 011-1h12a1 1 0 011 1v2a1 1 0 01-1 1H4a1 1 0 01-1-1v-2z" clip-rule="evenodd"></path>
                </svg>
              </div>
              Категория
            </h4>
            <p class="text-gray-800 font-semibold text-lg">{{ remark.category }}</p>
          </div>

          <!-- SLA Info -->
          {% if remark.sla_due %}
            <div class="glass-effect rounded-2xl p-6 border border-white/20 backdrop-blur-sm">
              <h4 class="text-lg font-bold text-gray-900 mb-4 flex items-center gap-2">
                <div class="w-8 h-8 bg-gradient-to-br from-amber-500 to-orange-600 rounded-lg flex items-center justify-center">
                  <svg class="w-4 h-4 text-white" fill="currentColor" viewBox="0 0 20 20">
                    <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm1-12a1 1 0 10-2 0v4a1 1 0 00.293.707l2.828 2.829a1 1 0 101.415-1.415L11 9.586V6z" clip-rule="evenodd"></path>
                  </svg>
                </div>
                SLA
              </h4>
              <p class="text-gray-800 font-semibold">Срок: {{ remark.sla_due|date:'d.m.Y H:i' }}</p>
              {% if remark.sla_due < remark.created_at %}
                <span class="inline-flex items-center px-3 py-1 rounded-xl text-sm font-bold bg-gradient-to-r from-red-500 to-rose-600 text-white mt-3 shadow-lg">
                  Просрочено
                </span>
              {% endif %}
            </div>
          {% endif %}

          <!-- Actions -->
          <div class="glass-effect rounded-2xl p-6 border border-white/20 backdrop-blur-sm">
            <h4 class="text-lg font-bold text-gray-900 mb-6 flex items-center gap-2">
              <div class="w-8 h-8 bg-gradient-to-br from-emerald-500 to-green-600 rounded-lg flex items-center justify-center">
                <svg class="w-4 h-4 text-white" fill="currentColor" viewBox="0 0 20 20">
                  <path fill-rule="evenodd" d="M11.3 1.046A1 1 0 0112 2v5h4a1 1 0 01.82 1.573l-7 10A1 1 0 018 18v-5H4a1 1 0 01-.82-1.573l7-10a1 1 0 011.12-.38z" clip-rule="evenodd"></path>
                </svg>
              </div>
              Действия
            </h4>
            <div class="space-y-4">
              {% if is_foreman %}
                {% if remark.status == 'OPEN' or remark.status == 'IN_PROGRESS' %}
                  <form method="post" action="{% url 'issues:confirm_resolution' remark.id %}">
                    {% csrf_token %}
                    <button type="submit" class="inline-flex items-center justify-center gap-3 px-6 py-4 text-sm text-white bg-gradient-to-r from-blue-500 to-indigo-600 rounded-xl hover:from-blue-600 hover:to-indigo-700 transition-all duration-300 font-semibold w-full shadow-lg hover:shadow-xl transform hover:scale-105 group">
                      <svg class="w-5 h-5 transition-transform duration-300 group-hover:scale-110" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"></path>
                      </svg>
                      Отправить на подтверждение устранения
                    </button>
                  </form>
                {% endif %}
              {% endif %}
              
              {% if is_inspector or is_foreman %}
                {% if remark.status == 'PENDING_CONFIRMATION' %}
                  <form method="post" action="{% url 'issues:confirm_closure' remark.id %}">
                    {% csrf_token %}
                    <button type="submit" class="inline-flex items-center justify-center gap-3 px-6 py-4 text-sm text-white bg-gradient-to-r from-emerald-500 to-green-600 rounded-xl hover:from-emerald-600 hover:to-green-700 transition-all duration-300 font-semibold w-full shadow-lg hover:shadow-xl transform hover:scale-105 group">
                      <svg class="w-5 h-5 transition-transform duration-300 group-hover:scale-110" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"></path>
                      </svg>
                      Подтвердить устранение
                    </button>
                  </form>
                {% endif %}
              {% endif %}
              
              <a href="{% url 'objects:detail' remark.object.id %}?tab=remarks" class="inline-flex items-center justify-center gap-3 px-6 py-4 text-sm text-gray-700 bg-gradient-to-r from-gray-100 to-gray-200 rounded-xl hover:from-gray-200 hover:to-gray-300 transition-all duration-300 font-semibold w-full shadow-lg hover:shadow-xl transform hover:scale-105 group">
                <svg class="w-5 h-5 transition-transform duration-300 group-hover:-translate-x-1" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 19l-7-7m0 0l7-7m-7 7h18"></path>
                </svg>
                Вернуться к объекту
              </a>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>
{% endblock %}